# 意见管理功能设计文档

## 1. 功能概述

意见管理是一个通用的反馈/工单系统，支持用户提交意见、系统智能分配处理人、处理人处理意见、管理员管理意见等完整流程。该功能可适用于多种业务场景：意见反馈、工单系统、Bug报告、需求收集等。

### 1.1 核心特性
- ✅ 用户创建意见，选择分类（通过数据字典配置）
- ✅ 系统智能分配处理人
- ✅ 处理人处理意见（回复、更新状态）
- ✅ 意见转派功能（支持并发控制）
- ✅ 管理员管理意见（调整优先级、标记重要、统计）
- ✅ 意见回复机制（类似评论区）
- ✅ 站内通知功能
- ✅ 与知识库系统关联（预留）

### 1.2 适用场景
- 企业内部意见反馈
- IT工单系统
- 客服工单系统
- Bug报告系统
- 需求收集系统
- 问题跟踪系统

---

## 2. 业务流程

### 2.1 意见提交流程
```
用户提交意见
    ↓
选择分类（数据字典配置）
    ↓
填写标题、内容
    ↓
系统智能分配处理人
    ↓
创建站内通知（通知处理人）
    ↓
意见状态：待处理
```

### 2.2 意见处理流程
```
处理人查看待处理意见
    ↓
处理意见（回复、更新状态）
    ↓
创建站内通知（通知提交人）
    ↓
意见状态：处理中 → 已处理
```

### 2.3 意见转派流程
```
处理人/管理员发起转派
    ↓
乐观锁检查（防止并发冲突）
    ↓
状态校验（确保可以转派）
    ↓
更新处理人
    ↓
创建站内通知（通知新处理人）
    ↓
记录转派日志
```

### 2.4 状态流转
```
待处理 → 处理中 → 已处理 → 已关闭
   ↓         ↓
   └─────────┘
   (可转派)
```

---

## 3. 数据结构设计

### 3.1 意见表 (advise)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键ID | PK, AUTO_INCREMENT |
| title | VARCHAR(256) | 意见标题 | NOT NULL |
| content | TEXT | 意见内容 | NOT NULL |
| category | VARCHAR(64) | 分类（字典值） | NOT NULL |
| priority | VARCHAR(32) | 优先级（低/中/高/紧急） | DEFAULT '中' |
| status | VARCHAR(32) | 状态（待处理/处理中/已处理/已关闭） | DEFAULT '待处理' |
| submitter_id | BIGINT | 提交人ID | NOT NULL, FK(user.id) |
| assignee_id | BIGINT | 处理人ID | NULL, FK(user.id) |
| is_important | TINYINT | 是否重要（0-否，1-是） | DEFAULT 0 |
| knowledge_id | BIGINT | 关联知识库ID | NULL, FK(knowledge.id) |
| version | INT | 版本号（乐观锁） | DEFAULT 1 |
| remark | VARCHAR(512) | 备注 | NULL |
| deleted | TINYINT | 逻辑删除（0-未删除，1-已删除） | DEFAULT 0 |
| create_by | BIGINT | 创建人ID | NULL |
| create_time | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| update_by | BIGINT | 更新人ID | NULL |
| update_time | DATETIME | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE |

**索引设计：**
- PRIMARY KEY (id)
- INDEX idx_submitter_id (submitter_id)
- INDEX idx_assignee_id (assignee_id)
- INDEX idx_status (status)
- INDEX idx_category (category)
- INDEX idx_create_time (create_time)
- INDEX idx_status_assignee (status, assignee_id)

### 3.2 意见回复表 (advise_reply)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键ID | PK, AUTO_INCREMENT |
| advise_id | BIGINT | 意见ID | NOT NULL, FK(advise.id) |
| reply_type | VARCHAR(32) | 回复类型（处理回复/追问） | NOT NULL |
| replyer_id | BIGINT | 回复人ID | NOT NULL, FK(user.id) |
| content | TEXT | 回复内容 | NOT NULL |
| deleted | TINYINT | 逻辑删除（0-未删除，1-已删除） | DEFAULT 0 |
| create_time | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |

**索引设计：**
- PRIMARY KEY (id)
- INDEX idx_advise_id (advise_id)
- INDEX idx_replyer_id (replyer_id)
- INDEX idx_create_time (create_time)

### 3.3 通知表 (notification) - 可选

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键ID | PK, AUTO_INCREMENT |
| user_id | BIGINT | 接收人ID | NOT NULL, FK(user.id) |
| type | VARCHAR(32) | 通知类型（意见分配/意见回复/状态变更） | NOT NULL |
| title | VARCHAR(256) | 通知标题 | NOT NULL |
| content | VARCHAR(512) | 通知内容 | NULL |
| related_id | BIGINT | 关联ID（意见ID） | NULL |
| is_read | TINYINT | 是否已读（0-未读，1-已读） | DEFAULT 0 |
| create_time | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |

**索引设计：**
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- INDEX idx_is_read (is_read)
- INDEX idx_type_related (type, related_id)

### 3.4 数据字典配置

#### 意见分类字典 (advise_category)
- 字典类型编码：`advise_category`
- 字典数据示例：
  - 功能建议
  - Bug反馈
  - 用户体验
  - 流程优化
  - 其他

#### 意见优先级字典 (advise_priority)
- 字典类型编码：`advise_priority`
- 字典数据：
  - 低
  - 中
  - 高
  - 紧急

#### 意见状态字典 (advise_status)
- 字典类型编码：`advise_status`
- 字典数据：
  - 待处理
  - 处理中
  - 已处理
  - 已关闭

#### 智能分配配置字典 (advise_assign_rule)
- 字典类型编码：`advise_assign_rule`
- 字典数据：分类 -> 默认处理人ID的映射
- 示例：
  - 功能建议 -> 1001 (产品经理ID)
  - Bug反馈 -> 1002 (开发负责人ID)
  - 流程优化 -> 1003 (流程管理负责人ID)

---

## 4. 功能清单

### 4.1 普通用户功能

#### 4.1.1 创建意见
- **功能描述**：用户创建新意见
- **输入参数**：
  - title: 意见标题（必填）
  - content: 意见内容（必填）
  - category: 分类（必填，从字典选择）
  - priority: 优先级（可选，默认"中"）
- **业务流程**：
  1. 校验参数
  2. 智能分配处理人（根据分类）
  3. 创建意见记录
  4. 创建站内通知（通知处理人）
  5. 返回意见ID

#### 4.1.2 查看我的意见
- **功能描述**：分页查询当前用户提交的意见
- **查询条件**：
  - 状态筛选
  - 分类筛选
  - 关键词搜索（标题、内容）
  - 时间范围
- **返回数据**：意见列表（包含基本信息、状态、处理人、回复数量等）

#### 4.1.3 查看意见详情
- **功能描述**：查看意见的完整信息
- **返回数据**：
  - 意见基本信息
  - 回复列表（时间倒序）
  - 处理进度
  - 关联知识库（如果有）

#### 4.1.4 追问
- **功能描述**：在意见下添加追问回复
- **输入参数**：
  - adviseId: 意见ID
  - content: 追问内容
- **业务流程**：
  1. 校验意见是否存在
  2. 校验用户是否有权限（必须是提交人）
  3. 创建回复记录
  4. 创建站内通知（通知处理人）
  5. 更新意见状态（如果已处理，改为处理中）

### 4.2 处理人功能

#### 4.2.1 查看待处理意见
- **功能描述**：分页查询分配给当前用户的待处理意见
- **查询条件**：
  - 状态筛选（默认待处理+处理中）
  - 分类筛选
  - 优先级筛选
  - 关键词搜索
- **返回数据**：意见列表

#### 4.2.2 处理意见
- **功能描述**：处理人回复意见并更新状态
- **输入参数**：
  - adviseId: 意见ID
  - replyContent: 回复内容（可选）
  - status: 目标状态（处理中/已处理）
- **业务流程**：
  1. 校验意见是否存在
  2. 校验用户是否有权限（必须是处理人）
  3. 如果有回复内容，创建回复记录
  4. 更新意见状态
  5. 创建站内通知（通知提交人）

#### 4.2.3 转派意见
- **功能描述**：将意见转派给其他处理人
- **输入参数**：
  - adviseId: 意见ID
  - newAssigneeId: 新处理人ID
  - reason: 转派原因（可选）
- **业务流程**：
  1. 使用乐观锁检查版本号
  2. 校验状态（确保可以转派）
  3. 校验新处理人是否存在
  4. 更新处理人
  5. 创建站内通知（通知新处理人）
  6. 记录转派日志（可选）

### 4.3 管理员功能

#### 4.3.1 查看所有意见
- **功能描述**：分页查询所有意见（不限制处理人）
- **查询条件**：
  - 状态筛选
  - 分类筛选
  - 优先级筛选
  - 提交人筛选
  - 处理人筛选
  - 是否重要筛选
  - 关键词搜索
  - 时间范围
- **返回数据**：意见列表

#### 4.3.2 调整优先级
- **功能描述**：管理员调整意见优先级
- **输入参数**：
  - adviseId: 意见ID
  - priority: 新优先级
- **业务流程**：
  1. 校验意见是否存在
  2. 更新优先级
  3. 如果优先级提升，创建站内通知（通知处理人）

#### 4.3.3 标记重要
- **功能描述**：将意见标记为重要/取消重要
- **输入参数**：
  - adviseId: 意见ID
  - isImportant: 是否重要（0/1）
- **业务流程**：
  1. 校验意见是否存在
  2. 更新重要标记

#### 4.3.4 转派意见
- **功能描述**：管理员转派意见（同处理人转派，但不需要权限校验）

#### 4.3.5 统计意见
- **功能描述**：统计意见数据
- **统计维度**：
  - 按状态统计（待处理、处理中、已处理、已关闭数量）
  - 按分类统计（各分类的数量）
  - 按优先级统计（各优先级的数量）
  - 按时间统计（今日、本周、本月、本年）
  - 处理效率统计（平均处理时长、超时率）
- **返回数据**：统计数据JSON

---

## 5. 智能分配策略

### 5.1 方案A：按分类分配（推荐，初期实现）

**实现逻辑：**
```java
1. 根据意见分类，查询数据字典 advise_assign_rule
2. 获取该分类对应的默认处理人ID
3. 如果找到，分配给该处理人
4. 如果未找到，分配给系统管理员或空（待手动分配）
```

**配置方式：**
- 通过数据字典 `advise_assign_rule` 配置
- 字典数据格式：`分类值 -> 处理人ID`
- 例如：`功能建议 -> 1001`

**优点：**
- 实现简单
- 配置灵活
- 易于维护

### 5.2 方案B：按部门分配（后续扩展）

**实现逻辑：**
```java
1. 获取提交人所在部门
2. 查询该部门的负责人
3. 分配给部门负责人
```

### 5.3 方案C：轮询分配（后续扩展）

**实现逻辑：**
```java
1. 查询该分类下所有可用的处理人
2. 统计每个处理人的待处理数量
3. 分配给待处理数量最少的处理人
```

### 5.4 方案D：智能推荐（后续扩展）

**实现逻辑：**
```java
1. 根据意见内容，使用NLP分析关键词
2. 匹配处理人的专业领域
3. 分配给最匹配的处理人
```

**初期建议：** 先实现方案A，后续根据需求扩展。

---

## 6. 并发控制方案

### 6.1 乐观锁实现

#### 6.1.1 实体类添加版本号字段
```java
@Version
private Integer version;
```

#### 6.1.2 更新时检查版本号
```java
// 1. 查询时获取版本号
AdviseEntity advise = adviseMapper.selectById(adviseId);
Integer oldVersion = advise.getVersion();

// 2. 更新时检查版本号
advise.setAssigneeId(newAssigneeId);
int updateCount = adviseMapper.updateById(advise);

// 3. 如果更新失败（版本号不匹配），抛出异常
if (updateCount == 0) {
    throw new BusinessException("意见已被其他人修改，请刷新后重试");
}
```

### 6.2 状态校验

#### 6.2.1 转派前状态检查
```java
// 转派前检查状态
if (!"待处理".equals(advise.getStatus()) && !"处理中".equals(advise.getStatus())) {
    throw new BusinessException("只有待处理或处理中的意见可以转派");
}
```

### 6.3 数据库锁（备选方案）

如果乐观锁不够，可以使用数据库锁：
```java
// 使用 SELECT ... FOR UPDATE 锁定记录
@Transactional
public void transferAdvise(Long adviseId, Long newAssigneeId) {
    // 锁定记录
    AdviseEntity advise = adviseMapper.selectByIdForUpdate(adviseId);
    // 执行更新
    advise.setAssigneeId(newAssigneeId);
    adviseMapper.updateById(advise);
}
```

**建议：** 使用乐观锁 + 状态校验，双重保障。

---

## 7. 回复机制设计

### 7.1 回复展示方式

意见详情页展示结构：
```
┌─────────────────────────────────────┐
│ 意见基本信息                          │
│ - 标题：系统登录有问题                │
│ - 内容：登录时提示密码错误...         │
│ - 状态：处理中                        │
│ - 处理人：张三                        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 回复列表（时间倒序）                   │
├─────────────────────────────────────┤
│ [处理人] 张三                         │
│ 已收到，正在排查中...                  │
│ 2026-01-21 10:00                     │
├─────────────────────────────────────┤
│ [提交人] 李四                         │
│ 大概什么时候能处理完？                 │
│ 2026-01-21 11:00                     │
├─────────────────────────────────────┤
│ [处理人] 张三                         │
│ 预计明天完成                          │
│ 2026-01-21 11:30                     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 回复输入框                            │
│ [根据角色显示：处理人可以回复，提交人可以追问] │
└─────────────────────────────────────┘
```

### 7.2 回复权限控制

- **处理人**：可以回复（回复类型：处理回复）
- **提交人**：可以追问（回复类型：追问）
- **管理员**：可以回复（回复类型：处理回复）

### 7.3 回复触发状态更新

- 如果意见状态是"已处理"，提交人追问后，自动改为"处理中"
- 处理人回复后，可以更新状态为"处理中"或"已处理"

---

## 8. 站内通知设计

### 8.1 通知类型

| 通知类型 | 触发场景 | 接收人 |
|---------|---------|--------|
| 意见分配 | 意见创建并分配处理人 | 处理人 |
| 意见回复 | 处理人回复意见 | 提交人 |
| 意见追问 | 提交人追问 | 处理人 |
| 状态变更 | 意见状态变更 | 提交人、处理人 |
| 意见转派 | 意见被转派 | 新处理人、原处理人 |
| 优先级调整 | 管理员调整优先级 | 处理人 |

### 8.2 通知创建时机

- 意见创建时：创建"意见分配"通知
- 回复创建时：创建"意见回复"或"意见追问"通知
- 状态更新时：创建"状态变更"通知
- 转派时：创建"意见转派"通知
- 优先级调整时：创建"优先级调整"通知

### 8.3 通知展示

- 在用户头像旁显示未读通知数量（红点）
- 点击后显示通知列表
- 点击通知跳转到对应意见详情页
- 已读/未读状态管理

---

## 9. 接口设计

### 9.1 用户接口

#### 9.1.1 创建意见
```
POST /advise
Request Body:
{
  "title": "意见标题",
  "content": "意见内容",
  "category": "功能建议",
  "priority": "高"
}
Response:
{
  "code": 200,
  "data": {
    "id": 1,
    "title": "意见标题",
    ...
  }
}
```

#### 9.1.2 分页查询我的意见
```
GET /advise/my?pageNum=1&pageSize=10&status=待处理&category=功能建议
Response:
{
  "code": 200,
  "data": {
    "records": [...],
    "total": 100,
    "pages": 10
  }
}
```

#### 9.1.3 查询意见详情
```
GET /advise/{id}
Response:
{
  "code": 200,
  "data": {
    "id": 1,
    "title": "意见标题",
    "content": "意见内容",
    "replies": [
      {
        "id": 1,
        "replyType": "处理回复",
        "replyerName": "张三",
        "content": "回复内容",
        "createTime": "2026-01-21 10:00:00"
      }
    ]
  }
}
```

#### 9.1.4 追问
```
POST /advise/{id}/reply
Request Body:
{
  "content": "追问内容"
}
```

### 9.2 处理人接口

#### 9.2.1 分页查询待处理意见
```
GET /advise/pending?pageNum=1&pageSize=10
```

#### 9.2.2 处理意见
```
POST /advise/{id}/handle
Request Body:
{
  "replyContent": "处理回复内容（可选）",
  "status": "已处理"
}
```

#### 9.2.3 转派意见
```
POST /advise/{id}/transfer
Request Body:
{
  "newAssigneeId": 1002,
  "reason": "转派原因（可选）"
}
```

### 9.3 管理员接口

#### 9.3.1 分页查询所有意见
```
GET /advise/all?pageNum=1&pageSize=10&status=待处理&submitterId=1001
```

#### 9.3.2 调整优先级
```
PUT /advise/{id}/priority
Request Body:
{
  "priority": "紧急"
}
```

#### 9.3.3 标记重要
```
PUT /advise/{id}/important
Request Body:
{
  "isImportant": 1
}
```

#### 9.3.4 统计意见
```
GET /advise/statistics?startTime=2026-01-01&endTime=2026-01-31
Response:
{
  "code": 200,
  "data": {
    "statusStats": {
      "待处理": 10,
      "处理中": 5,
      "已处理": 50,
      "已关闭": 5
    },
    "categoryStats": {
      "功能建议": 20,
      "Bug反馈": 30,
      ...
    },
    "priorityStats": {
      "低": 10,
      "中": 40,
      "高": 20,
      "紧急": 10
    }
  }
}
```

---

## 10. 技术实现要点

### 10.1 实体类设计

参考项目中的 `ConfigEntity`、`DictDataEntity` 等实体类的设计风格：
- 使用 `@TableName` 指定表名
- 使用 `@TableId` 指定主键
- 使用 `@TableField` 指定字段映射
- 使用 `@TableLogic` 实现逻辑删除
- 使用 `@Version` 实现乐观锁
- 使用 `@Schema` 添加API文档注解

### 10.2 Service层设计

参考 `DeptServiceImpl`、`PostServiceImpl` 的设计模式：
- 统一异常处理（BusinessException、ServerException）
- 事务管理（@Transactional）
- 日志记录（@Slf4j）
- 参数校验
- 业务逻辑封装

### 10.3 Mapper层设计

- 使用 MyBatis-Plus 的 BaseMapper
- 复杂查询使用 XML 配置
- 分页查询使用 MyBatis-Plus 的 Page 对象

### 10.4 DTO/VO设计

- DTO：用于接收前端参数（CreateDto、UpdateDto、QueryDto等）
- VO：用于返回给前端（包含关联数据，如处理人姓名、分类名称等）

---

## 11. 后续扩展

### 11.1 与知识库系统关联

- 意见处理完成后，可以关联到知识库
- 从重要意见中提取知识，生成知识库条目
- 处理意见时，可以搜索相关知识库内容

### 11.2 附件功能

- 支持上传附件（图片、文档等）
- 意见详情页展示附件列表
- 附件下载功能

### 11.3 评价功能

- 意见处理完成后，提交人可以评价
- 满意度评分（1-5星）
- 评价内容
- 评价统计

### 11.4 定时任务

- 超时提醒：超过一定时间未处理的意见，发送提醒
- 自动关闭：超过一定时间未更新的已处理意见，自动关闭
- 统计报表：定时生成统计报表

### 11.5 消息队列集成

- 异步处理通知（使用消息队列）
- 为后续群聊系统做准备
- 解耦业务逻辑

### 11.6 WebSocket实时推送

- 实时推送通知
- 意见状态变更实时更新
- 为后续群聊系统做准备

---

## 12. 开发计划

### 第一阶段：核心功能（必须）
1. ✅ 数据库表设计
2. ✅ 实体类、DTO、VO设计
3. ✅ 创建意见功能
4. ✅ 分页查询功能
5. ✅ 意见详情查询
6. ✅ 智能分配处理人（方案A）
7. ✅ 处理意见功能
8. ✅ 回复功能
9. ✅ 站内通知功能（简化版）

### 第二阶段：管理功能
1. ✅ 转派功能（含并发控制）
2. ✅ 调整优先级
3. ✅ 标记重要
4. ✅ 统计功能

### 第三阶段：扩展功能（可选）
1. ⬜ 附件功能
2. ⬜ 评价功能
3. ⬜ 定时任务
4. ⬜ 与知识库关联
5. ⬜ 消息队列集成
6. ⬜ WebSocket实时推送

---

## 13. 注意事项

### 13.1 数据字典配置

在系统初始化时，需要配置以下数据字典：
- `advise_category`：意见分类
- `advise_priority`：意见优先级
- `advise_status`：意见状态
- `advise_assign_rule`：智能分配规则

### 13.2 权限控制

- 普通用户：只能查看和操作自己提交的意见
- 处理人：可以查看和处理分配给自己的意见
- 管理员：可以查看和操作所有意见

### 13.3 性能优化

- 分页查询使用索引
- 关联查询使用JOIN优化
- 通知查询使用索引
- 统计查询考虑缓存

### 13.4 数据安全

- 逻辑删除，不物理删除
- 操作日志记录（可选）
- 敏感信息脱敏（可选）

---

## 14. 总结

意见管理功能是一个通用的反馈/工单系统，通过合理的架构设计和实现，可以适用于多种业务场景。核心设计要点：

1. **通用性**：通过数据字典配置，支持不同业务场景
2. **可扩展性**：预留关联字段，支持后续扩展
3. **并发安全**：使用乐观锁和状态校验，保证数据一致性
4. **用户体验**：回复机制、站内通知，提升交互体验
5. **学习价值**：涵盖CRUD、状态管理、并发控制、消息通知等技术点

---

**文档版本：** v1.0  
**创建时间：** 2026-01-29  
**作者：** li.hongyu
