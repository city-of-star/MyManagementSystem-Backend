<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mms.usercenter.service.auth.mapper.UserMapper">

    <select id="getUserPage" resultType="com.mms.usercenter.common.auth.vo.UserPageVo">
        SELECT
            u.id,
            u.username,
            u.nickname,
            u.real_name,
            u.gender,
            u.phone,
            u.email,
            u.status,
            u.locked,
            u.last_login_time,
            u.create_time,
            u.remark,
            d.dept_name primaryDeptName,
            p.post_name primaryPostName
        FROM user u
        LEFT JOIN user_dept ud on u.id = ud.user_id AND ud.is_primary = 1
        LEFT JOIN dept d on ud.dept_id = d.id
        LEFT JOIN user_post up on u.id = up.user_id AND up.is_primary = 1
        LEFT JOIN post p on up.post_id = p.id
        <where>
            u.deleted = 0
            <if test="dto.username != null and dto.username != ''">
                AND u.username LIKE CONCAT('%', #{dto.username}, '%')
            </if>
            <if test="dto.nickname != null and dto.nickname != ''">
                AND u.nickname LIKE CONCAT('%', #{dto.nickname}, '%')
            </if>
            <if test="dto.realName != null and dto.realName != ''">
                AND u.real_name LIKE CONCAT('%', #{dto.realName}, '%')
            </if>
            <if test="dto.email != null and dto.email != ''">
                AND u.email = #{dto.email}
            </if>
            <if test="dto.phone != null and dto.phone != ''">
                AND u.phone = #{dto.phone}
            </if>
            <if test="dto.status != null">
                AND u.status = #{dto.status}
            </if>
            <if test="dto.locked != null">
                AND u.locked = #{dto.locked}
            </if>
            <if test="dto.gender != null">
                AND u.gender = #{dto.gender}
            </if>
            <if test="dto.createTimeStart != null">
                AND u.create_time >= #{dto.createTimeStart}
            </if>
            <if test="dto.createTimeEnd != null">
                AND u.create_time &lt;= #{dto.createTimeEnd}
            </if>
            <if test="dto.lastLoginTimeStart != null">
                AND u.last_login_time >= #{dto.lastLoginTimeStart}
            </if>
            <if test="dto.lastLoginTimeEnd != null">
                AND u.last_login_time &lt;= #{dto.lastLoginTimeEnd}
            </if>
            <if test="dto.deptId != null">
                AND
                    EXISTS (
                        SELECT 1
                        FROM user_dept ud
                        WHERE ud.user_id = u.id
                            AND ud.dept_id = #{dto.deptId}
                    )
            </if>
            <if test="dto.postId != null">
                AND
                    EXISTS (
                        SELECT 1
                        FROM user_post up
                        WHERE up.user_id = u.id
                            AND up.post_id = #{dto.postId}
                    )
            </if>
        </where>
        ORDER BY u.create_time DESC
    </select>

    <select id="selectByUsername" resultType="com.mms.usercenter.common.auth.entity.UserEntity">
        SELECT
            id, username, password, nickname, real_name, avatar, email, phone, gender, birthday,
            status, locked, lock_time, lock_reason, last_login_time, last_login_ip,
            password_update_time, remark, create_by, create_time, update_by, update_time
        FROM user
        WHERE username = #{username}
          AND deleted = 0
    </select>

    <select id="selectByEmail" resultType="com.mms.usercenter.common.auth.entity.UserEntity">
        SELECT
            id, username, password, nickname, real_name, avatar, email, phone, gender, birthday,
            status, locked, lock_time, lock_reason, last_login_time, last_login_ip,
            password_update_time, remark, create_by, create_time, update_by, update_time
        FROM user
        WHERE email = #{email}
          AND deleted = 0
    </select>

    <select id="selectByPhone" resultType="com.mms.usercenter.common.auth.entity.UserEntity">
        SELECT
            id, username, password, nickname, real_name, avatar, email, phone, gender, birthday,
            status, locked, lock_time, lock_reason, last_login_time, last_login_ip,
            password_update_time, remark, create_by, create_time, update_by, update_time
        FROM user
        WHERE phone = #{phone}
          AND deleted = 0
    </select>

</mapper>

