<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mms.usercenter.service.org.mapper.DeptMapper">

    <!-- 部门VO字段列表 -->
    <sql id="DeptVoColumns">
        id, parent_id, dept_name, dept_code, leader, phone, email, sort_order, status, remark,
        create_by, create_time, update_by, update_time
    </sql>

    <!-- 分页查询部门列表 -->
    <select id="getDeptPage" resultType="com.mms.usercenter.common.org.vo.DeptVo">
        SELECT
            <include refid="DeptVoColumns"/>
        FROM dept
        <where>
            deleted = 0
            <if test="dto.deptName != null and dto.deptName != ''">
                AND dept_name LIKE CONCAT('%', #{dto.deptName}, '%')
            </if>
            <if test="dto.deptCode != null and dto.deptCode != ''">
                AND dept_code LIKE CONCAT('%', #{dto.deptCode}, '%')
            </if>
            <if test="dto.parentId != null">
                AND parent_id = #{dto.parentId}
            </if>
            <if test="dto.status != null">
                AND status = #{dto.status}
            </if>
            <if test="dto.createTimeStart != null">
                AND create_time >= #{dto.createTimeStart}
            </if>
            <if test="dto.createTimeEnd != null">
                AND create_time &lt;= #{dto.createTimeEnd}
            </if>
        </where>
        ORDER BY sort_order ASC, create_time DESC
    </select>

    <!-- 根据用户ID查询主部门信息 -->
    <select id="getPrimaryDeptByUserId" resultType="com.mms.usercenter.common.org.vo.DeptVo">
        SELECT
            d.id, d.parent_id, d.dept_name, d.dept_code, d.leader, d.phone, d.email, d.sort_order, d.status, d.remark,
            d.create_by, d.create_time, d.update_by, d.update_time
        FROM dept d
        INNER JOIN user_dept ud ON d.id = ud.dept_id
        WHERE ud.user_id = #{userId}
          AND ud.is_primary = 1
          AND d.deleted = 0
        LIMIT 1
    </select>

</mapper>

